# cBioPortal Meta-analysis Pipeline

**Status (mar25)**: early development

A pipeline to create some useful derived datasets and visualizations using the [cBioPortal](https://cbioportal.org) data.

At present, the pipeline is focused on mutation data, but this will be expanded in the near future
to include other data modalities.

# Usage

To run the pipeline, start by cloning the pipeline repo, and creating a conda environment with
the required dependencies.

E.g., using [micromamba](https://mamba.readthedocs.io/en/latest/installation/micromamba-installation.html
):

```
git clone https://github.com/khughitt/cbioportal-meta-pipeline
cd cbioportal-meta-pipeline

micromamba create -n cbioportal --file requirements.txt
```

Activate the environment:

```
micromamba activate cbioportal
```

Use one of the example config files in the "config" dir, or create your own config file with the
same structure.

Finally, use [Snakemake](https://snakemake.readthedocs.io/en/stable/) to run the pipeline,
specififying the config file you wish to use.

For example, to launch Snakemake with a single thread:

```
snakemake -j1 --configfile config/config-10k-genes.yml
```

_Note_: whereas data for most of the studies can be downloaded directly by the pipeline, AACR GENIE
requires users to have an account on synapse.org, and the data must be downloaded and added to the
pipeline input directory manually. For more information, see the [AACR GENIE project page on
synapse.org](https://www.synapse.org/Synapse:syn21683345).

# Pipeline output

Datasets generated by the pipeline fall into two main categories:

1. Data relating to a single study (`studies/`)
2. Data combining information across studies (`summary/`)

Example of study-level data outputs:

```
├── mut
│   ├── gene_cancer
│   │   └── gene_cancer_dataset.feather
│   ├── gene
│   │   └── gene_dataset.feather
│   ├── matrix
│   │   ├── gene_cancer.feather
│   │   └── gene_patient.feather
│   ├── cancer
│   │   └── cancer_dataset.feather
│   ├── mut_filtered.feather
│   ├── cor
│   │   ├── gene.feather
│   │   └── cancer.feather
│   ├── mut.feather
│   └── cancer_detailed
│       └── cancer_detailed_dataset.feather
├── metadata
│   ├── dataset.feather
│   ├── samples.feather
│   └── patients.feather
└── cor
    ├── gene.feather
    └── cancer.feather
```

Structure of combined / "summary" output:

```
├── mut
│   ├── gene_cancer_dataset.feather
│   ├── gene_dataset_ratio.feather
│   ├── gene_dataset.feather
│   ├── cancer_detailed_dataset.feather
│   ├── cancer_dataset.feather
│   ├── gene_cancer_dataset_ratio.feather
│   ├── cancer_detailed_dataset_ratio.feather
│   └── cancer_dataset_ratio.feather
├── metadata
│   └── samples.feather
├── datasets.feather
└── summary.html
```

For the individual study outputs, most of the output datasets (except for those in "matrix/" and
"cor/" subdirectories) are "long" format tables:

- `mut/mut.feather` and `mut/mut_filtered.feather` are structured similarly to the source
  `data_mutations.txt` file
- others have columns for the entity/entities (e.g. "gene") + "num" and "ratio" fields describing
  the mutation counts and ratios for those entities.

For the combined "summary" outputs, the most common format is a matrix of mutation counts or ratios.

The convention used is to first list the entity used to index the rows and then the entity used to
index the columns.

If more than two entities are included, the first ones correspond to alternative row indices.

So, for example:

- `gene_dataset.feather` has genes along rows and datasets along columns, and,
- `gene_cancer_dataset` has (gene, cancer) pairs along rows and datasets along columns

Files with  "ratio" in their filenames report the ratio of samples within a study that have at
least one mutation for a particular gene. Note that this will likely be modified in the future to
report the ratio of _patients_ with a mutation instead.
